<!-- BEGIN_TF_DOCS -->
# aws_lb

This module allows the creation of a load balancer and associated resources. It supports
application and network load balancers, but not gateway load balancers.

Some variables are exclusive to one type of load balancer, which is indicated by a
variable name prefix of `alb_` or `nlb_`. The variable `redirect_80_to_443` can be used
instead of setting up listeners for redirection manually. When used with a NLB, it
creates a separate ALB just to use for the redirect.

Target group names are randomly generated by Terraform to avoid length issues.

It's recommended to use the outputs of the aws_vpc module to obtain VPC and subnet IDs
as shown in the examples. This allows Terraform to correctly calculate dependencies so
you can build your VPC and LBs in one run. This may not always be possible, for example
if you're creating a LB in a network account where the VPC isn't managed by Terraform.

## Provider Requirements

This module requires two providers:

1) A default provider which is assuming a role in the account where the load balancer
resources will be created
2) A non-default provider with the alias `aws.support_account` which is assuming a role
in the Parsons Commercial Support account. This is used to add certificate domain
validation records to Route 53. This Commercial account holds the hosted zones for both
parsons.com and parsons.us

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_alb_drop_invalid_header_fields"></a> [alb\_drop\_invalid\_header\_fields](#input\_alb\_drop\_invalid\_header\_fields) | ALB only variable that determines whether the load balancer will drop invalid header<br>  fields or keep them. | `bool` | `true` | no |
| <a name="input_alb_fips"></a> [alb\_fips](#input\_alb\_fips) | This setting is only available for ALBs. Creates a FIPS enabled ALB.<br>  Note - this feature is still in AWS private preview | `bool` | `false` | no |
| <a name="input_certificates"></a> [certificates](#input\_certificates) | A map of certificates to create in ACM for the load balancer. Required if listeners<br>  are using HTTPS or TLS. The map key is the domain name. The certificates are<br>  automatically DNS validated in Route 53 in the Commercial support account. | <pre>map(object({<br>    # Map key = domain name<br>    subject_alternative_names = optional(list(string), [])<br>  }))</pre> | `{}` | no |
| <a name="input_deletion_protection"></a> [deletion\_protection](#input\_deletion\_protection) | Enable or disable deletion protection for the LB. | `bool` | `true` | no |
| <a name="input_deregistration_delay"></a> [deregistration\_delay](#input\_deregistration\_delay) | The amount of time, in seconds, that the LB will wait to change the state of the<br>  deregistering target from draining to unused. Range is 0-3600 seconds. | `number` | `300` | no |
| <a name="input_desync_mitigation_mode"></a> [desync\_mitigation\_mode](#input\_desync\_mitigation\_mode) | Determines how the load balancer handles requests that might pose a security risk to an application due to HTTP desync | `string` | `"defensive"` | no |
| <a name="input_external_tls_decryption"></a> [external\_tls\_decryption](#input\_external\_tls\_decryption) | Are we enabling external TLS decryption for<br>  the Palo Alto? True indicates that the HTTP/80 to HTTPS/443 redirect won't occur if<br>  coming from the internet through the Palo Alto. | `bool` | `false` | no |
| <a name="input_idle_timeout"></a> [idle\_timeout](#input\_idle\_timeout) | The time in seconds that the connection is allowed to be idle. Only valid for Load Balancers of type application | `number` | `60` | no |
| <a name="input_internal"></a> [internal](#input\_internal) | If the load balancer is internal or external | `bool` | n/a | yes |
| <a name="input_is_gov"></a> [is\_gov](#input\_is\_gov) | If the LB is being deployed in Commercial or GovCloud | `bool` | n/a | yes |
| <a name="input_listeners"></a> [listeners](#input\_listeners) | A map of listeners to create and attach to the LB. If the protocol is HTTPS or TLS,<br>  a default\_cert\_key is required. | <pre>map(object({<br>    default_cert_key    = optional(string)<br>    port                = number<br>    protocol            = string<br>    secondary_cert_keys = optional(list(string), [])<br>    default_action = object({<br>      fixed_response = optional(object({<br>        content_type = string<br>        message_body = optional(string)<br>        status_code  = optional(string)<br>      }))<br>      forward = optional(object({<br>        target_groups = map(object({<br>          key    = string<br>          weight = optional(number)<br>        }))<br>        stickiness = optional(object({<br>          enabled  = bool<br>          duration = optional(number)<br>        }))<br>      }))<br>      redirect = optional(object({<br>        host        = optional(string)<br>        path        = optional(string)<br>        port        = optional(string)<br>        protocol    = optional(string)<br>        query       = optional(string)<br>        status_code = string<br>      }))<br>      type             = string<br>      target_group_key = optional(string)<br>    })<br>    rules = optional(map(object({<br>      action = object({<br>        fixed_response = optional(object({<br>          content_type = string<br>          message_body = optional(string)<br>          status_code  = optional(string)<br>        }))<br>        forward = optional(object({<br>          target_groups = map(object({<br>            key    = string<br>            weight = optional(number)<br>          }))<br>          stickiness = optional(object({<br>            enabled  = bool<br>            duration = optional(number)<br>          }))<br>        }))<br>        redirect = optional(object({<br>          host        = optional(string)<br>          path        = optional(string)<br>          port        = optional(string)<br>          protocol    = optional(string)<br>          query       = optional(string)<br>          status_code = string<br>        }))<br>        type             = string<br>        target_group_key = optional(string)<br>      })<br>      conditions = map(object({<br>        host_header = optional(list(string))<br>        http_header = optional(object({<br>          http_header_name = string<br>          values           = list(string)<br>        }))<br>        http_request_method = optional(list(string))<br>        path_pattern        = optional(list(string))<br>        query_string = optional(map(object({<br>          key   = optional(string)<br>          value = string<br>        })), {})<br>        source_ip = optional(list(string))<br>      }))<br>      priority = optional(number)<br>    })), {})<br>  }))</pre> | n/a | yes |
| <a name="input_name"></a> [name](#input\_name) | The name of the load balancer | `string` | n/a | yes |
| <a name="input_nlb_dns_record_client_routing_policy"></a> [nlb\_dns\_record\_client\_routing\_policy](#input\_nlb\_dns\_record\_client\_routing\_policy) | Indicates how traffic is distributed among the load balancer Availability Zones.<br>Possible values are any\_availability\_zone (default), availability\_zone\_affinity, or<br>partial\_availability\_zone\_affinity. See [Availability Zone DNS affinity](<br>  https://docs.aws.amazon.com/elasticloadbalancing/latest/network/network-load-balancers.html#zonal-dns-affinity<br>) for additional details. Only valid for network type load balancers. Not supported<br>in GovCloud. | `string` | `"any_availability_zone"` | no |
| <a name="input_nlb_network_cross_zone"></a> [nlb\_network\_cross\_zone](#input\_nlb\_network\_cross\_zone) | This setting is only available for NLBs. Enable/disable cross-zone load balancing.<br>  For ALBs, this feature is always enabled and can't be disabled. | `bool` | `false` | no |
| <a name="input_redirect_80_to_443"></a> [redirect\_80\_to\_443](#input\_redirect\_80\_to\_443) | Automatically creates resources/configuration to redirect port 80 to 443.<br>  For ALBs this redirects using a listener.<br>  For NLBs creates an ALB to use as a target group which then handles the redirect. | `bool` | n/a | yes |
| <a name="input_region"></a> [region](#input\_region) | The AWS region where the LB is being deployed. Used for S3 bucket ARN. | `string` | n/a | yes |
| <a name="input_subnet_ids"></a> [subnet\_ids](#input\_subnet\_ids) | Subnet IDs to attach to the LB | `list(string)` | n/a | yes |
| <a name="input_tags"></a> [tags](#input\_tags) | Optional tags to override provider defaults | <pre>object({<br>    App         = optional(string)<br>    Environment = optional(string)<br>    GBU         = optional(string)<br>    ITSM        = optional(string, "NETWORK")<br>    JobWbs      = optional(string)<br>    Notes       = optional(string)<br>    Owner       = optional(string)<br>  })</pre> | `{}` | no |
| <a name="input_target_groups"></a> [target\_groups](#input\_target\_groups) | Target groups to create and attach to the LB. | <pre>map(object({<br>    health_check = object({<br>      path     = optional(string)<br>      port     = number<br>      protocol = string<br>      matcher  = optional(string, null)<br>    })<br>    alb_target_for_port_80_listener = optional(bool, false)<br>    # NLB only. Indicates whether the NLB terminates connections after the end of the<br>    # deregistration timeout.<br>    nlb_connection_termination = optional(bool, false)<br>    port                       = number<br>    # Enable/disable source IP preservation on the Target Group. Not applicable with<br>    # UDP or TCP_UDP Target Groups.<br>    nlb_preserve_client_ip = optional(bool)<br>    protocol               = string<br>    stickiness = optional(object({<br>      cookie_duration = optional(number, 86400)<br>      cookie_name     = optional(string)<br>      enabled         = optional(bool, true)<br>      type            = string<br>    }))<br>    targets                 = set(string)<br>    nlb_targets_outside_vpc = optional(bool, false)<br>    type                    = string<br>  }))</pre> | n/a | yes |
| <a name="input_type"></a> [type](#input\_type) | The type of load balancer - application, gateway, or network | `string` | n/a | yes |
| <a name="input_vpc_id"></a> [vpc\_id](#input\_vpc\_id) | The VPC that resources will be created in. | `string` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_arn"></a> [arn](#output\_arn) | Load balancer ARN |
| <a name="output_dns_name"></a> [dns\_name](#output\_dns\_name) | Load balancer DNS name |
| <a name="output_secondary_lb_for_redirect"></a> [secondary\_lb\_for\_redirect](#output\_secondary\_lb\_for\_redirect) | Seconday ALB details. Created as part of a NLB deployment for port 80 redirect. |
| <a name="output_security_groups"></a> [security\_groups](#output\_security\_groups) | Load balancer security group(s) |
| <a name="output_target_group_arns"></a> [target\_group\_arns](#output\_target\_group\_arns) | Load balancer target group ARNs |
| <a name="output_type"></a> [type](#output\_type) | Load balancer type |

## Resources

| Name | Type |
|------|------|
| [aws_acm_certificate.all](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/acm_certificate) | resource |
| [aws_acm_certificate_validation.all](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/acm_certificate_validation) | resource |
| [aws_lb.alb_redirect_80_to_443_for_nlb](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb) | resource |
| [aws_lb.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb) | resource |
| [aws_lb_listener.forward_80_to_alb](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener) | resource |
| [aws_lb_listener.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener) | resource |
| [aws_lb_listener.redirect_80_to_443](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener) | resource |
| [aws_lb_listener_certificate.secondary](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener_certificate) | resource |
| [aws_lb_listener_rule.external_tls_decryption](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener_rule) | resource |
| [aws_lb_listener_rule.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener_rule) | resource |
| [aws_lb_target_group.alb_redirect_80_to_443_for_nlb](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group) | resource |
| [aws_lb_target_group.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group) | resource |
| [aws_lb_target_group_attachment.alb_redirect_80_to_443_for_nlb](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group_attachment) | resource |
| [aws_lb_target_group_attachment.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group_attachment) | resource |
| [aws_route53_record.validation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record) | resource |
| [aws_security_group.alb](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group) | resource |
| [aws_vpc_security_group_egress_rule.allow_all_out_internal](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_security_group_egress_rule) | resource |
| [aws_vpc_security_group_ingress_rule.allow_80_from_internal](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_security_group_ingress_rule) | resource |
| [aws_vpc_security_group_ingress_rule.allow_80_from_internet](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_security_group_ingress_rule) | resource |
| [aws_vpc_security_group_ingress_rule.listener_ports_internal](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_security_group_ingress_rule) | resource |
| [aws_vpc_security_group_ingress_rule.listener_ports_internet](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_security_group_ingress_rule) | resource |
| [aws_route53_zone.parsons_domain](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/route53_zone) | data source |

## Examples

```hcl
# Example 1 - External NLB with certificate and 80 to 443 redirect
load_balancers = {
  "nlb-elmpro-tls-ext-prod" = {
    access_log_prefix = "nlb-elmpro-tls-ext-prod"
    certificates = {
      "elm.parsons.com" = {
        subject_alternative_names = ["elm.parsons.com"]
      }
    }
    internal = false
    listeners = {
      "listener-443" = {
        port             = 443
        protocol         = "TLS"
        target_group_key = "tg-nlb-port-11003"
        default_cert_key = "elm.parsons.com"
      }
    }
    nlb_network_cross_zone   = true
    redirect_80_to_443       = true
    subnet_ids               = ["subnet-06bcb8d36f20ba24e", "subnet-04030635e8ee35895"]
    target_group_name_prefix = "tg-elmpro-tls-ext-prod"
    target_groups = {
      "tg-nlb-port-11003" = {
        port               = 11003
        protocol           = "TLS"
        stickiness_enabled = false
        targets            = ["i-0ec595648d0494e01", "i-00bc3b08a55f95ed4"]
        type               = "instance"
        health_check = {
          port     = 11003
          protocol = "TCP"
        }
      }
    }
    type   = "network"
    vpc_id = "vpc-0f33b8af8702635e7"
  }
}

# Example 2 - DMZ ALB supporting TLS decryption with certificate and custom listener rule
load_balancers = {
  "alb-elmpro-tls-dmz-prod" = {
    certificates = {
      "elm.parsons.com" = {
        subject_alternative_names = ["elm.parsons.com"]
      }
    }
    deletion_protection            = false
    alb_drop_invalid_header_fields = false
    alb_external_tls_decryption    = true
    alb_fips                       = false
    internal                       = true
    listeners = {
      "listener-443" = {
        port             = 443
        protocol         = "HTTPS"
        target_group_key = "tg-port-443"
        default_cert_key = "elm.parsons.com"
        rules            = {
          forward_lqe_path_to_lqe_tg = {
            action = {
              type = "forward"
              target_group_key = "tg-port-443-lqe"
            }
            condition = {
              lqe = {
                path_pattern = ["/lqe*"]
              }
            }
          }
        }
      }
    }
    redirect_80_to_443 = true
    subnet_ids         = ["subnet-0ee5ec08b6c0a41d1", "subnet-01cdba01c51b4030b"]
    target_groups = {
      "tg-port-443" = {
        port                    = 443
        protocol                = "HTTPS"
        targets                 = ["10.41.129.98"]
        type                    = "ip"
        health_check = {
          path     = "/jts/auth/authrequired"
          port     = 443
          protocol = "HTTPS"
        }
      }
      "tg-port-443-lqe" = {
        port                    = 443
        protocol                = "HTTPS"
        targets                 = ["10.41.131.168"]
        type                    = "ip"
        health_check = {
          path     = "/lqe/web/admin/config"
          port     = 443
          protocol = "HTTPS"
        }
      }
    }
    type   = "application"
    vpc_id = "vpc-077a49cbe56a4076e"
  }
}
```
<!-- END_TF_DOCS -->